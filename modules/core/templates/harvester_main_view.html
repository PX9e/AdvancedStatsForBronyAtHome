<!DOCTYPE html>
<html>
<head>
    <title>Harvester ASFB@H Experimental Prototype</title>
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/ink.min.css') }}">
    <script type=text/javascript src="{{url_for('static', filename='js/jquery-1.11.0.min.js') }}"></script>
    <script type=text/javascript src="{{url_for('static', filename='js/ink-all.min.js') }}"></script>
</head>
<body>
<nav class="ink-navigation">
    <ul class="menu horizontal black">
        <li class="heading active"><a href="#">HARVESTER</a></li>
        <li><a href="/harvester/admin">Administration</a></li>
        <li><a href="/harvester">Harvester logs</a></li>
    </ul>
</nav>
<br>
<br>

<div class="ink-grid">
    <div class="column-group gutters">
        <div id="menu" class="all-25 small-100 tiny-100 " >


<form class="ink-form" name="table_options" id="table_options">
<fieldset>
<div class="control-group">
    <legend>Filters :</legend>
     <div class="column-group">
        <ul class="unstyled">
        <div class="all-25">
        <li>
            <div class="control-group align-center"><label for="check1">Complete</label></div>
            <div class="control"><input  onclick="refresh()" type="checkbox" name="option1" value="Complete" id="check1" /></div>
        </li></div>
        <div class="all-25">
        <li>
            <div class="control-group align-center"><label for="check2">Start</label></div>
            <div class="control"><input onclick="refresh()" type="checkbox" name="option2" value="Start" id="check2" /></div>
        </li></div>
         <div class="all-25">
        <li>
            <div class="control-group align-center"><label for="check3">Info</label></div>
            <div class="control"><input onclick="refresh()" type="checkbox" name="option3" value="Info" id="check3" /></div>
        </li></div>
        <div class="all-25">
        <li>
            <div class="control-group align-center"><label for="check4">Error</label></div>
            <div class="control"><input onclick="refresh()" type="checkbox" name="option4" value="Error" id="check4" /></div>
        </li></div>
</ul>
</div>
</div>
    <div class="control-group">
        <label for="module">Modules :</label>
        <div class="control">
            <input id="module" type="text" onkeyup="refresh()" name="module">
        </div>
         <p class="tip">ex: folding@home</p>
    </div>
    <div class="control-group">
        <label for="rows">Number of rows :</label>
        <div class="control">
            <input id="rows" type="text" onkeyup="refresh()" name="rows">
        </div>
         <p class="tip">ex: 100</p>
    </div>
    </fieldset>
</form>

</div>

<div class="log_table all-75 small-100 tiny-100">
       <h2>Logs table</h2>
       <table class="ink-table hover">
       <thead><tr>
           <th class="align-left"> Date </th>
           <th class="align-left"> Module </th>
           <th class="align-left"> Type </th>
           <th class="align-left"> Message </th>
       </tr></thead><tbody>
    {% for log in logs%}
     {% if log["type"] == "TYPE_COMPLETE" %}
        <tr class="blue">
    {% elif log["type"] == "TYPE_ERROR" %}
        <tr class="red">
    {% elif log["type"] == "TYPE_START" %}
        <tr class="yellow">
    {% else %}
        <tr>
    {% endif %}
           <td>{{log["datetime"]}}</td>
           <td>{{log["module"]}}</td>

           <td>{{log["type"]}}</td>

           <td>{{log["message"]}}</td>

        </tr>
    {% endfor %}
       </tbody></table>
</div>
 </div>
</div>
<script>
jQuery.ajaxSettings.traditional = true;
var lastDate = "";
var nbRowInitial = 20;
var nbRow = nbRowInitial;
var typesToPrint = [];

function refresh(){
    typesToPrint = [];

    if(true === table_options.option1.checked)
    {
        typesToPrint.push("TYPE_COMPLETE");
    }
    if(true === table_options.option2.checked)
    {
        typesToPrint.push("TYPE_START");
    }
    if(true === table_options.option3.checked)
    {
        typesToPrint.push("TYPE_INFO");
    }
    if(true === table_options.option4.checked)
    {
        typesToPrint.push("TYPE_ERROR");
    }

    if(typesToPrint==[])
    {
        typesToPrint.push("TYPE_COMPLETE");
        typesToPrint.push("TYPE_START");
        typesToPrint.push("TYPE_INFO");
        typesToPrint.push("TYPE_ERROR");
    }
    nbRow = parseInt(table_options.rows.value);

    if(isNaN(nbRow))
    {
        nbRow = nbRowInitial;
    }


    $.getJSON("/harvester/log",{type:typesToPrint, limit:nbRow, module:table_options.module.value},
      function(feedback){
          var mytbody = document.getElementsByTagName('tbody');
          var mycontent = "";
          for(field in feedback)
          {
                     switch (feedback[field].type) {
                         case "TYPE_COMPLETE":
                             mycontent = "<tr class='blue'>";
                             break;
                         case "TYPE_ERROR":
                             mycontent = "<tr class='red'>";
                             break;
                         case "TYPE_START":
                             mycontent = "<tr class='yellow'>";
                             break;
                         default:
                             mycontent = "<tr>";
                             break;
                     }
                     mycontent += "<td>" + new Date(feedback[field].datetime * 1000).toUTCString() + " </td><td> "+ feedback[field].module + "</td><td>" + feedback[field].type +" </td><td>"+ feedback[field].message+"</td></tr>";
                     lastDate = feedback[field].datetime;
          }
      mytbody[0].innerHTML = mycontent;
      }
      );

}

function getNewLogs(){
    $.getJSON("/harvester/log",{datetime: lastDate, type:typesToPrint, limit:nbRow, module:table_options.module.value},
      function(feedback){
      var myRows;
      var myList;
      var myContent;
      feedback.reverse();
      for(field in feedback)
          {
                     myContent = "";
                     myList = document.getElementsByTagName('tbody')[0];
                     myRows = myList.childNodes;
                     myRows[myRows.length-1].remove();
                     switch (feedback[field].type) {
                         case "TYPE_COMPLETE":
                             myContent = "<tr class='blue'>";
                             break;
                         case "TYPE_ERROR":
                             myContent = "<tr class='red'>";
                             break;
                         case "TYPE_START":
                             myContent = "<tr class='yellow'>";
                             break;
                         default:
                             myContent = "<tr>";
                             break;
                     }
                     myContent += "<td> " + new Date(feedback[field].datetime * 1000).toUTCString() + " </td><td> "+ feedback[field].module + "</td><td>" + feedback[field].type +" </td><td>"+ feedback[field].message+"</td></tr>" ;


                     myList.innerHTML = myContent + myList.innerHTML;
                     lastDate = feedback[field].datetime;
          }

          }
         );

    setTimeout(function(){getNewLogs();}, 5000);}

refresh();
setTimeout(getNewLogs(),5000);

</script>
</body>
</html>
